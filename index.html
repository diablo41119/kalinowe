<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Turniej Kalinowe Pole ‚Äì LiveScore (Pary)</title>
<style>
:root{
  --bg:#0b1020; --card:#121933; --muted:#9bb0d6; --accent:#9fd25b;
  --text:#eef3ff; --danger:#ff7070; --ok:#7be495;
}
body.light{
  --bg:#f2f4ff; --card:#ffffff; --muted:#5b678a; --accent:#0077ff;
  --text:#0a0a0a; --danger:#d94a4a; --ok:#15803d;
}
*{box-sizing:border-box;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial}
body{margin:0;padding:0;background:var(--bg);color:var(--text);transition:.3s background,.3s color}
header{position:sticky;top:0;z-index:50;background:rgba(11,16,32,.95);backdrop-filter:blur(8px);
  border-bottom:1px solid #22305e;display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:10px}
body.light header{background:rgba(255,255,255,.95);border-bottom:1px solid #ccc}
h1{font-size:18px;margin:0 10px 0 0;font-weight:800}
button{cursor:pointer;border:none;border-radius:10px;padding:8px 12px;font-weight:700}
.btn{background:var(--accent);color:#fff}
.secondary{background:var(--card);color:var(--text);border:1px solid #2a3a72}
main{padding:10px;max-width:1200px;margin:0 auto}
.section-title{margin:14px 4px 6px;font-weight:900;color:var(--accent);font-size:18px}
.grid{overflow:auto;border-radius:12px;border:1px solid #2a3a72;background:var(--card)}
table{width:100%;border-collapse:collapse;min-width:760px}
th,td{padding:6px;border-bottom:1px dashed #243468;text-align:center}
thead th{position:sticky;top:120px;background:var(--card);z-index:10}
th:first-child,td:first-child{text-align:left;padding-left:10px}
input[type=number]{width:70px;text-align:center;padding:6px;border-radius:8px;border:1px solid #2a3a72;
background:#0e1430;color:var(--text)}
body.light input[type=number]{background:#fff;color:#000;border:1px solid #ccc}
.leaderboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px}
.card{background:var(--card);border:1px solid #2a3a72;border-radius:12px;padding:10px}
.flex-between{display:flex;justify-content:space-between;align-items:center}
.badge{padding:3px 7px;border-radius:999px;background:#213169;font-size:13px}
.good{background:rgba(74,210,115,0.15);border:1px solid #4ad273}
.bad{background:rgba(255,107,107,0.15);border:1px solid #ff6b6b}
.footer{text-align:center;font-size:12px;color:var(--muted);margin-top:10px}
.spinner{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;
background:rgba(0,0,0,.6);color:#fff;font-size:18px;z-index:200}
.hidden{display:none}
.toggle-bar{margin-left:auto;display:flex;gap:6px;align-items:center}
</style>
</head>
<body>
<header>
  <h1>Turniej Kalinowe Pole ‚Äì LiveScore (Pary)</h1>
  <button id="toggleTheme" class="secondary">üåô/‚òÄÔ∏è</button>
  <button id="fullscreenBtn" class="secondary">‚õ∂</button>
  <div class="toggle-bar">
    <input id="gameId" placeholder="ID gry" value="kalinowe"/>
    <button id="joinBtn" class="btn">Do≈ÇƒÖcz</button>
  </div>
</header>

<main>
  <div id="loading" class="spinner hidden">≈Åadowanie wynik√≥w...</div>

  <div class="section-title">Indywidualny leaderboard</div>
  <section id="leaderboard" class="leaderboard"></section>

  <div class="section-title">Leaderboard par (Best Ball)</div>
  <section id="teamboard" class="leaderboard"></section>

  <div class="grid">
    <table><thead id="thead"></thead><tbody id="tbody"></tbody><tfoot id="tfoot"></tfoot></table>
  </div>

  <p class="footer">Live Firestore ‚Ä¢ Best Ball ‚Ä¢ Kalinowe Pole</p>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } 
  from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyDSd57ttRgz_kpaVKurxg7dSXnTSrjQF54",
  authDomain:"kalinowe-pola.firebaseapp.com",
  projectId:"kalinowe-pola"
});
const db = getFirestore(app);

const PLAYERS=["Oliwia","Karolina","Jƒôdrek","Miko≈Çaj","Krystian","Kosma"];
const TEAMS={
  jk:{name:"Jƒôdrek + Kosma",players:["Jƒôdrek","Kosma"],hcp:30},
  km:{name:"Krystian + Miko≈Çaj",players:["Krystian","Miko≈Çaj"],hcp:24},
  ko:{name:"Karolina + Oliwia",players:["Karolina","Oliwia"],hcp:38}
};
const HOLES=18;
let state={}, gameId="kalinowe";

const thead=document.getElementById("thead"),tbody=document.getElementById("tbody"),tfoot=document.getElementById("tfoot");
const leaderboard=document.getElementById("leaderboard"),teamboard=document.getElementById("teamboard");
const spinner=document.getElementById("loading");

function qs(id){return document.getElementById(id);}
qs("toggleTheme").onclick=()=>{document.body.classList.toggle("light");
 localStorage.setItem("theme",document.body.classList.contains("light")?"light":"dark");};
if(localStorage.getItem("theme")==="light")document.body.classList.add("light");

qs("fullscreenBtn").onclick=()=>{if(!document.fullscreenElement)document.documentElement.requestFullscreen();
else document.exitFullscreen();};

qs("joinBtn").onclick=async()=>{
 gameId=qs("gameId").value.trim()||"kalinowe";
 spinner.classList.remove("hidden");
 const ref=doc(db,"games",gameId);
 const snap=await getDoc(ref);
 if(!snap.exists()){
   const par={},scores={};
   for(let h=1;h<=HOLES;h++){par["h"+h]=4;}
   for(const p of PLAYERS){scores[p]={};for(let h=1;h<=HOLES;h++)scores[p]["h"+h]=null;}
   await setDoc(ref,{par,scores,teams:TEAMS});
 }
 onSnapshot(ref,s=>{
   spinner.classList.add("hidden");
   state=s.data();
   render();
 });
};

function updateField(path,val){
 const ref=doc(db,"games",gameId);
 const payload={}; payload[path]=val;
 updateDoc(ref,payload);
}

function render(){
 const par=state.par||{},scores=state.scores||{};
 // table head
 thead.innerHTML=""; const thr=document.createElement("tr");
 thr.innerHTML=`<th>Do≈Çek</th><th>PAR</th>${PLAYERS.map(p=>`<th>${p}</th>`).join("")}`;
 thead.append(thr);
 // body
 tbody.innerHTML="";
 for(let h=1;h<=HOLES;h++){
  const tr=document.createElement("tr");
  tr.innerHTML=`<td>H${h}</td><td><input type="number" min="3" max="6" value="${par["h"+h]||4}"></td>`+
   PLAYERS.map(p=>{
     const v=scores[p]?.["h"+h]??"";
     return `<td><input data-player="${p}" data-hole="${h}" type="number" value="${v}" min="1" max="20"></td>`;
   }).join("");
  tbody.append(tr);
 }
 tbody.querySelectorAll("input[data-player]").forEach(inp=>{
  inp.onchange=()=>updateField(`scores.${inp.dataset.player}.h${inp.dataset.hole}`,Number(inp.value));
 });
 tbody.querySelectorAll("td input:not([data-player])").forEach(inp=>{
  inp.onchange=()=>updateField(`par.h${[...inp.closest("tr").children].indexOf(inp.parentNode)-1+1}`,Number(inp.value));
 });

 // leaderboards
 renderLeaders(par,scores);
 renderTeams(par,scores);
}

function sumPar(par){return Object.values(par).reduce((a,b)=>a+Number(b||4),0);}
function playerTotal(p,par,scores){
 let s=0,d=0,has=false;
 for(let h=1;h<=HOLES;h++){const sc=scores[p]?.["h"+h];const pa=par["h"+h]||4;
  if(sc!=null){s+=+sc;d+=+sc-pa;has=true;}
 }
 return {s,delta:d,has};
}
function renderLeaders(par,scores){
 leaderboard.innerHTML="";
 const pars=sumPar(par);
 const arr=PLAYERS.map(p=>({p,...playerTotal(p,par,scores)})).filter(x=>x.has);
 arr.sort((a,b)=>a.delta-b.delta);
 arr.forEach((a,i)=>{
  const card=document.createElement("div");card.className="card";
  card.innerHTML=`<div class="flex-between"><h3>${i+1}. ${a.p}</h3>
    <span class="badge ${a.delta<0?"good":a.delta>0?"bad":""}">${a.s} (${a.delta>0?"+":""}${a.delta})</span></div>
    <div class="tiny muted">Par: ${pars}</div>`;
  leaderboard.append(card);
 });
}

function bestBall(team,par,scores){
 let gross=0,have=false;for(let h=1;h<=HOLES;h++){
  const p=par["h"+h]||4;
  const a=scores[team.players[0]]?.["h"+h],b=scores[team.players[1]]?.["h"+h];
  let best=null;if(a!=null&&b!=null)best=Math.min(+a,+b);else if(a!=null)best=+a;else if(b!=null)best=+b;
  if(best!=null){gross+=best;have=true;}
 }
 const pars=sumPar(par),net=gross-team.hcp;
 return {gross,net,delta:gross-pars};
}
function renderTeams(par,scores){
 teamboard.innerHTML="";
 const arr=Object.values(TEAMS).map(t=>({t,...bestBall(t,par,scores)})).sort((a,b)=>a.net-b.net);
 arr.forEach((a,i)=>{
  const c=document.createElement("div");c.className="card";
  c.innerHTML=`<div class="flex-between"><h3>${i+1}. ${a.t.name}</h3>
  <div><span class="badge ${a.delta<0?"good":a.delta>0?"bad":""}">GROSS:${a.gross||"-"} (${a.delta>0?"+":""}${a.delta})</span>
  <span class="badge">NET:${a.net||"-"}</span></div></div>
  <div class="tiny">HCP:<input type="number" value="${a.t.hcp}" style="width:60px"></div>`;
  c.querySelector("input").onchange=e=>updateField(`teams.${Object.keys(TEAMS)[i]}.hcp`,+e.target.value);
  teamboard.append(c);
 });
}
</script>
</body>
</html>